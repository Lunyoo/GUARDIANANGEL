# üöÄ MELHORIAS CR√çTICAS NO FLUXO DE CONVERSA - GUARDIANANGEL

## üéØ **MELHORIAS NO PROMPT-CABE√áA (Mais Urgentes)**

### 1. **DETEC√á√ÉO DE URG√äNCIA E ABANDONO INTELIGENTE**
```typescript
// No prompt-cabe√ßa:
`
üö® DETECTAR SINAIS DE URG√äNCIA:
- "preciso urgente" ‚Üí priorizar entrega r√°pida  
- "para amanh√£" ‚Üí focar em COD se dispon√≠vel
- "evento/festa" ‚Üí enfatizar prazo de entrega

‚ö†Ô∏è SINAIS PARA ABANDONAR CONVERSA:
- Cliente disse "n√£o quero", "n√£o tenho interesse", "n√£o preciso"
- Cliente n√£o responde por mais de 3 mensagens seguidas
- Cliente fala claramente "pare de me mandar mensagem"
- Cliente demonstra irrita√ß√£o clara

RESPOSTAS POR URG√äNCIA:
- Alta: "Entendo a urg√™ncia! Vou te ajudar rapidinho..."
- M√©dia: "Vou te ajudar com sua calcinha modeladora..."
- Baixa: "Posso te ajudar com nossa calcinha ShapeFit..."
`
```

### 2. **RECONHECIMENTO DE DESIST√äNCIA**
```typescript
// Adicionar sistema de abandono inteligente:
`
üõë QUANDO PARAR DE INSISTIR:
- "n√£o quero" = PARAR IMEDIATAMENTE
- "n√£o tenho dinheiro" = oferecer condi√ß√£o especial UMA VEZ, depois parar
- "vou pensar" = dar espa√ßo, follow-up em 2 horas MAX
- "n√£o √© pra mim" = perguntar se √© presente, se n√£o, PARAR
- Sem resposta h√° 20+ minutos = follow-up √∫nico, depois abandonar

FRASES PARA ENCERRAR EDUCADAMENTE:
- "Tudo bem! Qualquer coisa, estou aqui! üòä"  
- "Sem problemas! Se mudar de ideia, me chama! üíñ"
- "Entendo! Estarei aqui se precisar! ‚ú®"
`
```

### 3. **OBJE√á√ïES E RESPEITO AOS PRE√áOS ML**
```typescript
// Adicionar tratamento autom√°tico:
`
üõ°Ô∏è TRATAMENTO DE OBJE√á√ïES COMUNS:
- "muito caro" ‚Üí "Entendo! √â um investimento na sua autoestima. Quer que eu explique os benef√≠cios?"
- "n√£o tenho certeza" ‚Üí "Normal! Que d√∫vida espec√≠fica posso esclarecer?"
- "vou pensar" ‚Üí "Claro! Que tal eu te mando mais informa√ß√µes?"
- "n√£o √© pra mim" ‚Üí "Ah, √© presente? Ou voc√™ quer mais detalhes primeiro?"

‚ö†Ô∏è REGRA CR√çTICA DOS PRE√áOS:
- JAMAIS inventar pre√ßos
- SEMPRE usar o pre√ßo injetado pelo ML: ${precoML}
- NUNCA oferecer desconto sem autoriza√ß√£o do sistema
- Se cliente questiona pre√ßo, explicar VALOR/BENEF√çCIOS, n√£o baixar pre√ßo

NUNCA INSISTIR AGRESSIVAMENTE - RESPEITAR O "N√ÉO"
`
```

## ü§ñ **MELHORIAS FORA DO PROMPT-CABE√áA**

### 4. **SISTEMA DE FOLLOW-UP RESPEITOSO COM ABANDONO**
```typescript
// Implementar sistema de acompanhamento com limite
async function scheduleIntelligentFollowUp(phone: string, behavior: string, context: any) {
  const followUpStrategies = {
    'photo_request': {
      delay: 30 * 60 * 1000, // 30 min
      message: "Oi! Conseguiu ver as fotos? Alguma d√∫vida? üì∏",
      maxAttempts: 1
    },
    'price_objection': {
      delay: 2 * 60 * 60 * 1000, // 2 horas
      message: "Oi! Se mudou de ideia sobre a calcinha, estou aqui! ÔøΩ",
      maxAttempts: 1
    },
    'abandoned_after_interest': {
      delay: 60 * 60 * 1000, // 1 hora
      message: "Oi! Ainda posso te ajudar com a calcinha? üõçÔ∏è",
      maxAttempts: 1
    },
    'size_doubt': {
      delay: 45 * 60 * 1000, // 45 min  
      message: "Oi! Sobre o tamanho, posso te dar uma dica! üìè",
      maxAttempts: 1
    }
  }
  
  const strategy = followUpStrategies[behavior]
  if (strategy) {
    // Verificar se j√° tentou o m√°ximo de vezes
    const attempts = await getFollowUpAttempts(phone, behavior)
    if (attempts >= strategy.maxAttempts) {
      console.log(`üõë M√°ximo de follow-ups atingido para ${phone}: ${behavior}`)
      return
    }
    
    setTimeout(async () => {
      const isStillActive = await checkIfConversationActive(phone)
      const customerWantsContact = await checkIfCustomerAcceptsContact(phone)
      
      if (!isStillActive && customerWantsContact) {
        await sendWhatsAppMessage(phone, strategy.message)
        await incrementFollowUpAttempts(phone, behavior)
        console.log(`üîÑ Follow-up enviado para ${phone}: ${behavior}`)
      } else if (!customerWantsContact) {
        console.log(`üõë Cliente ${phone} n√£o quer mais contato`)
      }
    }, strategy.delay)
  }
}
```

### 5. **SISTEMA DE COOLDOWN INTELIGENTE**
```typescript
// Evitar spam e melhorar experi√™ncia
class ConversationCooldown {
  private static cooldowns = new Map<string, number>()
  
  static shouldSendMessage(phone: string): boolean {
    const lastMessage = this.cooldowns.get(phone) || 0
    const now = Date.now()
    const cooldownTime = 2 * 60 * 1000 // 2 minutos
    
    if (now - lastMessage < cooldownTime) {
      console.log(`‚è≥ Cooldown ativo para ${phone} - aguardando`)
      return false
    }
    
    this.cooldowns.set(phone, now)
    return true
  }
  
  static getTimeRemaining(phone: string): number {
    const lastMessage = this.cooldowns.get(phone) || 0
    const now = Date.now()
    const cooldownTime = 2 * 60 * 1000
    return Math.max(0, cooldownTime - (now - lastMessage))
  }
}
```

### 5. **DETEC√á√ÉO DE ABANDONO E RECUPERA√á√ÉO RESPEITOSA**
```typescript
// Sistema para detectar quando cliente abandona
async function detectAndRecoverAbandonment(phone: string, conversationHistory: any[]) {
  const lastMessage = conversationHistory[conversationHistory.length - 1]
  const timeSinceLastMessage = Date.now() - new Date(lastMessage.timestamp).getTime()
  
  // Verificar sinais de desist√™ncia
  const hasRejection = conversationHistory.some(msg => 
    msg.content.toLowerCase().includes('n√£o quero') ||
    msg.content.toLowerCase().includes('n√£o tenho interesse') ||
    msg.content.toLowerCase().includes('pare') ||
    msg.content.toLowerCase().includes('chato')
  )
  
  if (hasRejection) {
    console.log(`üõë Cliente ${phone} demonstrou desinteresse - n√£o fazer follow-up`)
    await markCustomerAsUninterested(phone)
    return
  }
  
  // Se passou mais de 3 horas sem resposta - APENAS 1 tentativa
  if (timeSinceLastMessage > 3 * 60 * 60 * 1000) {
    const alreadyTriedRecovery = await checkRecoveryAttempt(phone)
    
    if (!alreadyTriedRecovery) {
      const conversationStage = detectConversationStage(conversationHistory)
      
      let recoveryMessage = ''
      
      switch (conversationStage) {
        case 'interested_but_no_data':
          recoveryMessage = "Oi! Se ainda tiver interesse na calcinha, me chama! üòä"
          break
        case 'provided_data_no_confirmation':
          recoveryMessage = "Oi! Seus dados est√£o aqui. Se quiser finalizar, me avisa! üìù"
          break
        default:
          recoveryMessage = "Oi! Se precisar de alguma coisa, me chama! üòä"
      }
      
      await sendWhatsAppMessage(phone, recoveryMessage)
      await markRecoveryAttempted(phone)
      console.log(`üîÑ Recovery message enviada para ${phone} - n√£o tentar√° novamente`)
    }
  }
}
```

### 7. **M√âTRICAS E ANALYTICS EM TEMPO REAL**
```typescript
// Sistema para monitorar performance da conversa
class ConversationAnalytics {
  static trackConversationFlow(phone: string, stage: string, action: string) {
    const analytics = {
      phone,
      stage,
      action,
      timestamp: new Date().toISOString(),
      sessionId: `session_${phone}_${Date.now()}`
    }
    
    // Salvar no banco para dashboard
    saveAnalytics(analytics)
    
    // M√©tricas em tempo real
    this.updateMetrics(stage, action)
  }
  
  static updateMetrics(stage: string, action: string) {
    const metrics = getMetrics()
    
    // Incrementar contadores
    metrics[`${stage}_${action}`] = (metrics[`${stage}_${action}`] || 0) + 1
    
    // Calcular taxas de convers√£o
    if (stage === 'data_collection' && action === 'completed') {
      metrics.data_collection_rate = metrics.data_collection_completed / metrics.data_collection_started
    }
    
    if (stage === 'sale' && action === 'confirmed') {
      metrics.conversion_rate = metrics.sale_confirmed / metrics.conversation_started
    }
    
    updateMetrics(metrics)
  }
}
```

### 8. **PERSONALIZA√á√ÉO DIN√ÇMICA DO DISCURSO**
```typescript
// Adaptar discurso baseado no perfil do cliente
function getPersonalizedTone(phone: string, conversationHistory: any[]): string {
  const clientProfile = analyzeClientProfile(conversationHistory)
  
  if (clientProfile.writingStyle === 'formal') {
    return 'formal_respeitoso'
  } else if (clientProfile.writingStyle === 'casual') {
    return 'descontraido_amigavel'
  } else if (clientProfile.responseSpeed === 'fast') {
    return 'direto_objetivo'
  } else if (clientProfile.responseSpeed === 'slow') {
    return 'paciencia_detalhado'
  }
  
  return 'equilibrado_natural'
}

// Adicionar ao prompt-cabe√ßa:
const dynamicTone = getPersonalizedTone(phone, conversationHistory)
`TOM PERSONALIZADO: ${dynamicTone} - Adapte suas respostas a este perfil`
```

### 6. **VALIDA√á√ÉO EM TEMPO REAL COM PRE√áOS ML**
```typescript
// Validar resposta antes de enviar
async function validateResponseBeforeSending(response: string, context: any): Promise<string> {
  // Verificar se menciona link sem ter dados completos
  if (response.includes('link') && !context.hasCompleteData) {
    return response.replace(/link de pagamento/g, 'formul√°rio de pedido')
  }
  
  // CRITICAL: Verificar se inventou pre√ßos
  const pricePattern = /R\$\s*\d+[,.]?\d*/g
  const mentionedPrices = response.match(pricePattern) || []
  const authorizedPrice = context.mlPrice // Pre√ßo vindo do ML
  
  for (const price of mentionedPrices) {
    if (!price.includes(authorizedPrice)) {
      console.error(`üö® BOT TENTOU INVENTAR PRE√áO: ${price} (autorizado: ${authorizedPrice})`)
      // Remover pre√ßos n√£o autorizados
      response = response.replace(pricePattern, authorizedPrice)
    }
  }
  
  // Verificar se est√° sendo muito insistente
  if (response.includes('urgente') && context.insistenceCount > 2) {
    return "Tudo bem! Se mudar de ideia, me chama! üòä"
  }
  
  // Verificar se est√° repetindo informa√ß√µes
  if (context.lastResponses.includes(response.substring(0, 50))) {
    return "Posso esclarecer alguma d√∫vida espec√≠fica? üòä"
  }
  
  return response
}
```

### 10. **CONTEXTO DE CONCORR√äNCIA E MERCADO**
```typescript
// Adicionar ao prompt-cabe√ßa conhecimento sobre concorr√™ncia
const marketContext = `
üí∞ CONTEXTO DE MERCADO:
- Principais concorrentes: [listar principais marcas]
- Nosso diferencial: Qualidade premium + entrega r√°pida
- Pre√ßo m√©dio do mercado: R$ 70-120
- Nossa vantagem: COD em ${codCities.length} cidades

üéØ USO ESTRAT√âGICO:
- Se cliente menciona pre√ßo de concorrente: "Entendo! Nosso pre√ßo reflete a qualidade premium e a garantia."
- Se cliente compara: "√ìtima pergunta! O que mais te preocupa na hora de escolher?"
- Se cliente tem d√∫vida: "Posso te explicar por que investimos tanto na qualidade..."
`
```

## üéØ **IMPLEMENTA√á√ÉO PRIORIT√ÅRIA:**

### **ALTA PRIORIDADE (Implementar primeiro):**
1. ‚úÖ Sistema de abandono inteligente (reconhecer quando parar)
2. ‚úÖ Valida√ß√£o de pre√ßos ML (nunca inventar pre√ßos)  
3. ‚úÖ Obje√ß√µes respeitosas no prompt
4. ‚úÖ Follow-up com limite m√°ximo

### **M√âDIA PRIORIDADE:**
5. ‚úÖ Detec√ß√£o de sinais de desist√™ncia
6. ‚úÖ Recovery com m√°ximo 1 tentativa
7. ‚úÖ Cooldown inteligente
8. ‚úÖ Analytics b√°sicas

## üé™ **EXEMPLO DE PROMPT-CABE√áA MELHORADO:**

```
Voc√™ √© Amanda, especialista em calcinha modeladora ShapeFit Premium.

 PRE√áO FIXO (NUNCA MUDAR): ${precoML} 
üèôÔ∏è CLIENTE EM: ${city} - ${deliveryInfo}
ÔøΩ ESTRAT√âGIA ATIVA: ${activeStrategy}

ÔøΩ QUANDO PARAR DE INSISTIR:
- Cliente disse "n√£o quero", "n√£o tenho interesse", "n√£o preciso" = PARAR IMEDIATAMENTE
- Cliente n√£o responde por 3+ mensagens = PARAR
- Cliente demonstra irrita√ß√£o = PARAR EDUCADAMENTE
- "Vou pensar" = dar espa√ßo, follow-up √öNICO em 2h

üõ°Ô∏è TRATAMENTO DE OBJE√á√ïES:
- "muito caro" ‚Üí "Entendo! √â um investimento na sua autoestima. Quer que eu explique os benef√≠cios?"
- "n√£o tenho certeza" ‚Üí "Normal! Que d√∫vida espec√≠fica posso esclarecer?" 
- "vou pensar" ‚Üí "Claro! Estarei aqui se precisar! üòä"

‚ö†Ô∏è REGRAS CR√çTICAS:
- JAMAIS inventar pre√ßos - usar APENAS: ${precoML}
- NUNCA mencionar "link" antes de dados completos
- RESPEITAR o "n√£o" do cliente
- APENAS 1 produto: calcinha modeladora ShapeFit Premium

üéØ PR√ìXIMO PASSO: ${nextStep}

Seja natural, emp√°tica e respeitosa! üíñ
```

---

**Total de melhorias focadas: 6 cr√≠ticas**
**Foco: Respeitoso + Pre√ßos corretos + Abandono inteligente**

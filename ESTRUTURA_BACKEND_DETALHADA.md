# üìÅ ESTRUTURA DETALHADA - BACKEND & ML

> **Detalhamento completo do backend Node.js e sistemas ML do GUARDIANANGEL**

## ‚öôÔ∏è **BACKEND CORE ARCHITECTURE**

### **üöÄ Servidor Principal (`server.ts`)**
```typescript
// Entry point do sistema
express()
  .use(cors(), helmet(), rateLimit())
  .use('/api/auth', authRoutes)
  .use('/api/campaigns', campaignRoutes)
  .use('/api/ml', mlRoutes)
  .use('/api/bot', botRoutes)
  .listen(3001)
```

**Features**:
- ‚úÖ Express.js com TypeScript
- ‚úÖ Middlewares de seguran√ßa (Helmet, CORS)
- ‚úÖ Rate limiting inteligente
- ‚úÖ Error handling global
- ‚úÖ Request logging
- ‚úÖ Health checks

---

## üõ£Ô∏è **SISTEMA DE ROTAS DETALHADO**

### **üîê Autentica√ß√£o (`/routes/auth.ts`)**
```typescript
POST   /login          - Login com email/senha
POST   /register       - Registro de usu√°rio
POST   /refresh        - Refresh JWT token
DELETE /logout         - Logout
GET    /profile        - Perfil do usu√°rio
PUT    /profile        - Atualizar perfil
```

### **üìä Campanhas (`/routes/campaigns.ts`)**
```typescript
GET    /campaigns              - Listar campanhas
POST   /campaigns              - Criar campanha
GET    /campaigns/:id          - Detalhes da campanha
PUT    /campaigns/:id          - Atualizar campanha
DELETE /campaigns/:id          - Deletar campanha
GET    /campaigns/:id/insights - Insights da campanha
POST   /campaigns/sync         - Sincronizar com Facebook
```

### **üìò Facebook Integration (`/routes/facebook.ts`)**
```typescript
GET    /facebook/accounts      - Contas publicit√°rias
GET    /facebook/campaigns     - Campanhas Facebook
GET    /facebook/insights      - Insights detalhados
POST   /facebook/upload-image  - Upload de criativo
PUT    /facebook/campaign/:id  - Atualizar campanha
GET    /facebook/top-performers - Top performers
POST   /facebook/optimize      - Otimiza√ß√£o autom√°tica
```

### **ü§ñ Bot & IA (`/routes/bot.ts`)**
```typescript
POST   /bot/message            - Enviar mensagem
GET    /bot/status             - Status do bot
GET    /bot/conversations      - Conversas ativas
POST   /bot/test-response      - Testar resposta
GET    /bot/metrics            - M√©tricas do bot
POST   /bot/training           - Treinar modelo
```

### **üß† Machine Learning (`/routes/ml.ts`)**
```typescript
GET    /ml/dashboard           - Dashboard ML
GET    /ml/bandits             - Universal Bandits status
POST   /ml/bandits/reward      - Registrar reward
GET    /ml/budget-allocator    - Budget allocator status
POST   /ml/optimize            - Otimiza√ß√£o manual
GET    /ml/neural-orchestrator - Neural orchestrator
POST   /ml/approve/:id         - Aprovar decis√£o ML
```

---

## ü§ñ **SISTEMA BOT AVAN√áADO**

### **üí¨ Conversation Engine (`conversationGPT_fixed.ts`)**

#### **Core Functions**:
```typescript
// Fun√ß√£o principal de processamento
async function processConversationMessage(
  phone: string, 
  message: string, 
  cityDetected?: string
): Promise<string>

// Gerador de prompts din√¢micos
function buildClientPromptWithDynamicPricing(pricingArm?: any): string

// Detec√ß√£o de cidades COD
function detectCityInMessage(message: string): string | null

// Simula√ß√£o de digita√ß√£o humanizada
function calculateTypingTime(message: string): number
```

#### **Advanced Features**:
- ‚úÖ **Dynamic Pricing** - Pre√ßos baseados em ML
- ‚úÖ **City Detection** - COD area detection
- ‚úÖ **Anti-Robot** - Conversa√ß√£o natural
- ‚úÖ **Thread Management** - Contexto persistente
- ‚úÖ **GPT-4 Integration** - OpenAI API
- ‚úÖ **Media Processing** - √Åudio e imagem
- ‚úÖ **Sales Funnel** - Automa√ß√£o de vendas

### **üì® Inbound Processor (`inboundProcessorGPT.ts`)**

#### **Core Features**:
```typescript
// Processamento principal
async function processInboundMessage(
  phone: string,
  message: string,
  mediaPath?: string
): Promise<ProcessResult>

// Anti-duplica√ß√£o avan√ßada
const processedMessages = new Map<string, number>()
const leadCreationInProgress = new Map<string, Promise<any>>()

// Extra√ß√£o de dados do cliente
function extractCustomerData(phone: string, history: any[]): CustomerData
```

#### **ML Integration**:
- ‚úÖ **Universal Bandits** - Decis√µes otimizadas
- ‚úÖ **Lead Scoring** - Classifica√ß√£o autom√°tica
- ‚úÖ **Neural Orchestrator** - Orquestra√ß√£o inteligente
- ‚úÖ **Anti-Duplication** - Thread-safe processing

### **üì± WhatsApp Client (`whatsappClient.fixed.ts`)**

#### **Dual Integration**:
```typescript
// Baileys (prim√°rio) + Venom (backup)
async function initWhatsApp(): Promise<void>
async function sendWhatsAppMessage(phone: string, message: string): Promise<void>
async function sendWhatsAppMedia(phone: string, mediaPath: string): Promise<void>

// Status e health checks
function isWhatsAppReady(): boolean
function getWhatsAppStatus(): ConnectionStatus
```

---

## üß† **MACHINE LEARNING CORE**

### **üé∞ Universal Bandits (`universalBandits.ts`)**

#### **Multi-Armed Bandits System**:
```typescript
interface UniversalBanditArm {
  id: string
  category: 'pricing' | 'approach' | 'timing' | 'media' | 'closing'
  variant: string
  // M√©tricas ML
  impressions: number
  interactions: number
  conversions: number
  revenue: number
  // Confian√ßa estat√≠stica
  confidence: number
  ucbScore: number
}

class UniversalBanditSystem {
  // 65+ arms com Thompson Sampling
  getBestPricing(context: BanditContext): UniversalBanditArm
  getBestApproach(context: BanditContext): UniversalBanditArm
  recordReward(armId: string, reward: number): void
}
```

#### **Context-Aware Decisions**:
```typescript
interface BanditContext {
  customerProfile: 'new' | 'returning' | 'interested'
  city: string
  hasCodeDelivery: boolean
  timeOfDay: 'morning' | 'afternoon' | 'evening'
  conversationStage: 'opening' | 'presenting' | 'closing'
  messageCount: number
}
```

### **üéØ Neural Orchestrator (`neuralOrchestrator.ts`)**

#### **ML Decision Engine**:
```typescript
class NeuralOrchestrator {
  async processLead(leadId: string): Promise<NeuralDecision>
  async processEvent(leadId: string, eventType: string): Promise<void>
  async getDashboardData(): Promise<MLDashboard>
}

interface NeuralDecision {
  leadId: string
  score: number
  segment: string
  botAction: any
  reasoning: string[]
  actions: { scoring?: any; botAction?: any }
}
```

### **üí∞ Budget Allocator (`budgetAllocator.ts`)**

#### **Intelligent Budget Distribution**:
```typescript
interface AllocationDecision {
  id: string
  strategy: string
  allocations: CampaignAllocation[]
  expectedTotalROI: number
  diversificationScore: number
  approved?: boolean
}

class BudgetAllocatorCore {
  async allocateBudget(): Promise<AllocationDecision>
  async approveD√©cision(id: string): Promise<void>
  getAllCampaigns(): CampaignMetrics[]
}
```

#### **ROI Optimization**:
- ‚úÖ **Historical Analysis** - An√°lise de performance passada
- ‚úÖ **Predictive Modeling** - Predi√ß√£o de ROI
- ‚úÖ **Risk Management** - Diversifica√ß√£o inteligente
- ‚úÖ **Approval Workflow** - Sistema de aprova√ß√µes

### **üöÄ Auto Optimizer (`autoOptimizer.ts`)**

#### **Self-Learning System**:
```typescript
class AutoOptimizer {
  async runOptimizationCycle(): Promise<OptimizationResult>
  async analyzePerformance(): Promise<PerformanceAnalysis>
  async generateApprovals(): Promise<Approval[]>
  async executeApprovedOptimizations(): Promise<void>
}

interface OptimizationResult {
  optimizations: number
  improvements: string[]
  recommendations: string[]
  performance: { before: any; after: any }
}
```

#### **Optimization Strategies**:
- ‚úÖ **Exploration Boost** - Aumento autom√°tico de explora√ß√£o
- ‚úÖ **Performance Monitoring** - Monitoramento cont√≠nuo
- ‚úÖ **Automatic Adjustments** - Ajustes autom√°ticos
- ‚úÖ **A/B Testing** - Testes autom√°ticos

---

## üìò **FACEBOOK INTEGRATION**

### **üîó Facebook API (`facebookAPI.ts`)**

#### **Complete Marketing API Integration**:
```typescript
class FacebookMarketingAPI {
  // Account Management
  async getAdAccounts(): Promise<AdAccount[]>
  async getAccountSummary(dateRange: string): Promise<AccountSummary>
  
  // Campaign Management
  async getCampaigns(limit?: number): Promise<Campaign[]>
  async createCampaign(data: CampaignData): Promise<Campaign>
  async updateCampaign(id: string, data: Partial<CampaignData>): Promise<Campaign>
  
  // Insights & Analytics
  async getAdInsights(dateRange: string, limit: number): Promise<AdInsights[]>
  async getTopPerformers(metric: string): Promise<AdInsights[]>
  async getCreativeInsights(creativeId: string): Promise<CreativeInsights>
  
  // Creative Management
  async getAdCreatives(limit?: number): Promise<AdCreative[]>
  async uploadImage(imageData: Buffer): Promise<string>
}
```

#### **Real-Time Data Sync**:
```typescript
// Campaign Synchronization
class FacebookCampaignSync {
  async syncAllCampaigns(): Promise<SyncResult>
  async syncCampaignToBudgetAllocator(campaign: Campaign): Promise<void>
  async fetchCampaignInsights(campaignId: string): Promise<Insights>
}
```

---

## üóÑÔ∏è **DATABASE ARCHITECTURE**

### **üìä Prisma Schema (`schema.prisma`)**

#### **Core Models**:
```prisma
model User {
  id            String @id @default(uuid())
  email         String @unique
  password      String
  // API Configuration
  facebookToken String?
  adAccountId   String?
  // Relationships
  campaigns     Campaign[]
  creatives     Creative[]
}

model Campaign {
  id           String @id @default(uuid())
  facebookId   String? @unique
  name         String
  status       String @default("DRAFT")
  // Metrics
  impressions  Int @default(0)
  clicks       Int @default(0)
  conversions  Int @default(0)
  spend        Float @default(0)
  roas         Float @default(0)
}

model Lead {
  id           String @id @default(uuid())
  phone        String @unique
  name         String?
  city         String?
  status       String @default("NEW")
  firstContact DateTime?
  lastContact  DateTime?
}

model Conversation {
  id        String @id @default(uuid())
  leadId    String
  messages  Json
  status    String
  createdAt DateTime @default(now())
}
```

### **üîÑ Data Flow**:
```mermaid
WhatsApp ‚Üí Inbound Processor ‚Üí Conversation GPT ‚Üí Universal Bandits ‚Üí Neural Orchestrator ‚Üí Budget Allocator ‚Üí Facebook API
```

---

## üõ†Ô∏è **MIDDLEWARE SYSTEM**

### **üîê Authentication (`middleware/auth.ts`)**
```typescript
export const authMiddleware = (req: Request, res: Response, next: NextFunction) => {
  // JWT validation
  // Role-based access control
  // API key validation
}
```

### **üìù Request Logger (`middleware/requestLogger.ts`)**
```typescript
export const requestLogger = (req: Request, res: Response, next: NextFunction) => {
  // Request/response logging
  // Performance tracking
  // Error correlation
}
```

### **‚ö° Rate Limiting (`middleware/rateLimit.ts`)**
```typescript
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 100, // limit each IP to 100 requests per windowMs
  message: 'Too many requests'
})
```

---

## üöÄ **PERFORMANCE & SCALABILITY**

### **üìä Caching Strategy**:
- ‚úÖ **Redis** para cache de sess√µes
- ‚úÖ **Memory cache** para dados ML
- ‚úÖ **Database indices** otimizados
- ‚úÖ **Query optimization** com Prisma

### **üîÑ Queue System**:
- ‚úÖ **BullMQ** para processamento ass√≠ncrono
- ‚úÖ **Message queue** para WhatsApp
- ‚úÖ **CAPI queue** para Facebook
- ‚úÖ **ML decision queue** para processing

### **üìà Monitoring**:
- ‚úÖ **Winston** logging system
- ‚úÖ **Performance metrics** tracking
- ‚úÖ **Error tracking** com context
- ‚úÖ **Health checks** autom√°ticos

---

## üîß **CONFIGURATION MANAGEMENT**

### **üåç Environment Variables**:
```bash
# Database
DATABASE_URL="file:./prisma/neural_system.db"

# APIs
OPENAI_API_KEY="sk-..."
FACEBOOK_ACCESS_TOKEN="EAABwz..."
FACEBOOK_AD_ACCOUNT_IDS="act_123,act_456"

# WhatsApp
ADMIN_PHONE="554199509644"
WA_HEADLESS="false"

# ML Configuration
AUTO_DB="1"
ALLOCATOR_AUTO="true"
BOT_METRICS_PUBLIC="false"

# Server
PORT="3001"
NODE_ENV="development"
JWT_SECRET="your-secret"
```

### **‚öôÔ∏è Configuration Files**:
- `config/database.ts` - Database configuration
- `config/redis.ts` - Redis configuration  
- `config/logger.ts` - Logging configuration

---

## üß™ **TESTING INFRASTRUCTURE**

### **üî¨ Test Structure**:
```
tests/
‚îú‚îÄ‚îÄ unit/           - Unit tests
‚îú‚îÄ‚îÄ integration/    - Integration tests
‚îú‚îÄ‚îÄ e2e/           - End-to-end tests
‚îú‚îÄ‚îÄ load/          - Load testing
‚îî‚îÄ‚îÄ fixtures/      - Test data
```

### **üõ†Ô∏è Testing Tools**:
- ‚úÖ **Jest** para unit tests
- ‚úÖ **Supertest** para API testing
- ‚úÖ **Prisma test environment**
- ‚úÖ **ML model validation**

---

## üéØ **ARQUITETURA RESUMIDA**

**Este backend representa um sistema de n√≠vel enterprise com**:

‚úÖ **Microservices Architecture** - Servi√ßos especializados  
‚úÖ **ML-First Design** - Machine Learning em cada decis√£o  
‚úÖ **Real-time Processing** - Decis√µes em tempo real  
‚úÖ **Auto-scaling** - Otimiza√ß√£o autom√°tica  
‚úÖ **Enterprise Security** - JWT, rate limiting, validation  
‚úÖ **Production Ready** - Monitoring, logging, error handling  
‚úÖ **API-First** - RESTful APIs bem documentadas  
‚úÖ **Event-Driven** - Architecture orientada a eventos  

**Complexidade**: Sistema de **alta complexidade** com 50,000+ linhas de c√≥digo üåüüåüüåüüåüüåü

---

*Esta arquitetura backend suporta milhares de usu√°rios simult√¢neos com decis√µes ML em tempo real* üöÄ
